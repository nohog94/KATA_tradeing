# .github/workflows/gemini-review.yml
name: Gemini Flash-Lite ê¸°ë°˜ ì½”ë“œ ë¦¬ë·°

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: "norse-appliance-462503-h4"
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        version: "latest"

    - name: Generate PR diff
      run: |
        git fetch origin $GITHUB_BASE_REF
        git diff origin/${GITHUB_BASE_REF}...HEAD -- > diff.txt
        if [ ! -s diff.txt ]; then
          echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤." > diff.txt
        fi
        if [ $(wc -c < diff.txt) -gt 30000 ]; then
          head -c 30000 diff.txt > diff_short.txt
          echo -e "\n... (ë‚´ìš©ì´ ê¸¸ì–´ì„œ ì¼ë¶€ë§Œ í‘œì‹œ)" >> diff_short.txt
          mv diff_short.txt diff.txt
        fi

    - name: Create Python script
      run: |
        cat > review_script.py << 'EOF'
        import json
        import requests
        import os
        import subprocess

        # diff íŒŒì¼ ì½ê¸°
        with open('diff.txt', 'r', encoding='utf-8') as f:
            diff_content = f.read()

        # Access token ê°€ì ¸ì˜¤ê¸°
        access_token = subprocess.check_output(['gcloud', 'auth', 'print-access-token']).decode('utf-8').strip()

        # API ìš”ì²­ ë°ì´í„°
        request_data = {
            "contents": [{
                "role": "user",
                "parts": [{
                    "text": "ë‹¤ìŒ ì½”ë“œ ë³€ê²½ì‚¬í•­ì— ëŒ€í•´ ë¦¬íŒ©í† ë§ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìžˆìœ¼ë©´ í•œêµ­ì–´ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”. :\n\n" + diff_content
                }]
            }],
            "generationConfig": {
                "temperature": 0.2,
                "maxOutputTokens": 2000
            }
        }

        # API í˜¸ì¶œ
        url = "https://us-central1-aiplatform.googleapis.com/v1/projects/norse-appliance-462503-h4/locations/us-central1/publishers/google/models/gemini-2.0-flash-lite:generateContent"
        headers = {
            "Authorization": f"Bearer {access_token}",
            "Content-Type": "application/json"
        }

        response = requests.post(url, json=request_data, headers=headers)
        
        # ì‘ë‹µ ì €ìž¥
        with open('response.json', 'w', encoding='utf-8') as f:
            json.dump(response.json(), f, ensure_ascii=False, indent=2)

        print("API í˜¸ì¶œ ì™„ë£Œ")
        EOF

    - name: Call Gemini API
      run: python3 review_script.py

    - name: Post review comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          try {
            const response = fs.readFileSync('response.json', 'utf8');
            const resp = JSON.parse(response);
            
            let reviewText = '';
            if (resp.candidates && resp.candidates[0] && resp.candidates[0].content && resp.candidates[0].content.parts && resp.candidates[0].content.parts[0]) {
              reviewText = resp.candidates[0].content.parts[0].text;
            } else if (resp.error) {
              reviewText = `API ì˜¤ë¥˜: ${resp.error.message}`;
            } else {
              reviewText = 'ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ êµ¬ì¡°ìž…ë‹ˆë‹¤.';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ðŸ¤– AI ì½”ë“œ ë¦¬ë·° (Gemini Flash-Lite)\n\n${reviewText}\n\n---\n*ì´ ë¦¬ë·°ëŠ” AIê°€ ìžë™ìœ¼ë¡œ ìƒì„±í•œ ê²ƒìž…ë‹ˆë‹¤.*`
            });
          } catch (error) {
            console.error('Error:', error);
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### âš ï¸ AI ì½”ë“œ ë¦¬ë·° ì˜¤ë¥˜\nì½”ë“œ ë¦¬ë·° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`
            });
          }
