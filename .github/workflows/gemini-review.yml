# .github/workflows/gemini-review.yml
name: Gemini Flash-Lite ê¸°ë°˜ ì½”ë“œ ë¦¬ë·°

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1) ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - uses: actions/checkout@v3

      # 2) GCP ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: "norse-appliance-462503-h4"           # ë³¸ì¸ GCP í”„ë¡œì íŠ¸ ID
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          version: "latest"      

      # 4) PR diff ì¶”ì¶œ
      - name: Generate PR diff
        id: diff
        run: echo "DIFF<<EOF" >> $GITHUB_ENV && git diff origin/${{ github.base_ref }}...HEAD >> $GITHUB_ENV && echo "EOF" >> $GITHUB_ENV

      - name: Call Gemini Flash-Lite
        id: gemini
        run: |
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://us-central1-aiplatform.googleapis.com/v1/projects/YOUR_PROJECT_ID/locations/us-central1/publishers/google/models/gemini-2.0-flash-lite:predict" \
            -d @- <<EOF
          {
            "instances":[{"content":${{ toJson(env.DIFF) }}}],
            "parameters":{"temperature":0.2}
          }
          EOF
          )
          echo "RESPONSE<<EOF" >> $GITHUB_ENV
          echo "$RESPONSE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Post AI review comment    # â† run ë¸”ë¡ ë°”ê¹¥, ê°™ì€ ë ˆë²¨ë¡œ ì •ë ¬
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const resp = JSON.parse(process.env.RESPONSE);
            const review = resp.predictions[0].content;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### ğŸ¤– AI ì½”ë“œ ë¦¬ë·° (Gemini Flash-Lite)\n\`\`\`text\n${review}\n\`\`\``
            });
