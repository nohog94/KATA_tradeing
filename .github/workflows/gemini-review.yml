# .github/workflows/gemini-review.yml
name: Gemini Flash-Lite ê¸°ë°˜ ì½”ë“œ ë¦¬ë·°

on:
  pull_request:
    types: [opened, synchronize]

# GitHub Actions ê¶Œí•œ ì„¤ì • ì¶”ê°€
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1) ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout repo (fetch full history)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2) GCP ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: "norse-appliance-462503-h4"
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          version: "latest"

      # 3) PR diff ì¶”ì¶œ ë° íŒŒì¼ë¡œ ì €ì¥
      - name: Generate PR diff
        id: diff
        run: |
          git fetch origin $GITHUB_BASE_REF
          git diff origin/${GITHUB_BASE_REF}...HEAD -- > diff.txt
          
          # diffê°€ ë„ˆë¬´ í¬ë©´ ìë¥´ê¸° (Gemini API í† í° ì œí•œ)
          if [ $(wc -c < diff.txt) -gt 50000 ]; then
            head -c 50000 diff.txt > diff_truncated.txt
            echo -e "\n\n... (diffê°€ ë„ˆë¬´ ê¸¸ì–´ì„œ ì˜ë ¸ìŠµë‹ˆë‹¤)" >> diff_truncated.txt
            mv diff_truncated.txt diff.txt
          fi

      # 4) Gemini API í˜¸ì¶œ (JSON ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì œ í•´ê²°)
      - name: Call Gemini Flash-Lite
        id: gemini
        run: |
          ACCESS_TOKEN=$(gcloud auth print-access-token)
          
          # diff ë‚´ìš©ì„ JSONìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë³€í™˜
          DIFF_CONTENT=$(cat diff.txt | jq -Rs .)
          
          # ìš”ì²­ í˜ì´ë¡œë“œ ìƒì„±
          cat > request.json <<EOF
          {
            "contents": [{
              "parts": [{
                "text": "ë‹¤ìŒ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ í•œêµ­ì–´ë¡œ ë¦¬ë·°í•´ì£¼ì„¸ìš”. ê°œì„ ì ì´ë‚˜ ì ì¬ì  ë¬¸ì œì ì„ ì°¾ì•„ì£¼ì„¸ìš”:\n\n${DIFF_CONTENT}"
              }]
            }],
            "generationConfig": {
              "temperature": 0.2,
              "maxOutputTokens": 2000
            }
          }
EOF
          
          echo "=== API ìš”ì²­ ì¤€ë¹„ ì™„ë£Œ ==="
          
          # API í˜¸ì¶œ
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://us-central1-aiplatform.googleapis.com/v1/projects/norse-appliance-462503-h4/locations/us-central1/publishers/google/models/gemini-2.0-flash-lite:generateContent" \
            -d @request.json)
          
          echo "=== API ì‘ë‹µ ==="
          echo "$RESPONSE"
          echo "================"
          
          # ì‘ë‹µì„ íŒŒì¼ë¡œ ì €ì¥ (í™˜ê²½ë³€ìˆ˜ ê¸¸ì´ ì œí•œ íšŒí”¼)
          echo "$RESPONSE" > response.json

      # 5) AI ë¦¬ë·° ëŒ“ê¸€ ì‘ì„±
      - name: Post AI review comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            try {
              const response = fs.readFileSync('response.json', 'utf8');
              console.log('Raw response:', response);
              
              const resp = JSON.parse(response);
              console.log('Parsed response:', JSON.stringify(resp, null, 2));
              
              let reviewText = '';
              
              // Gemini API ì‘ë‹µ êµ¬ì¡° í™•ì¸
              if (resp.candidates && resp.candidates[0] && resp.candidates[0].content && resp.candidates[0].content.parts && resp.candidates[0].content.parts[0]) {
                reviewText = resp.candidates[0].content.parts[0].text;
              } else if (resp.error) {
                reviewText = `API ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${resp.error.message}`;
              } else {
                reviewText = 'ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ êµ¬ì¡°ì…ë‹ˆë‹¤.';
              }
              
              // PRì— ëŒ“ê¸€ ì‘ì„±
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `### ğŸ¤– AI ì½”ë“œ ë¦¬ë·° (Gemini Flash-Lite)

${reviewText}

---
*ì´ ë¦¬ë·°ëŠ” AIê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ê²ƒì…ë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.*`
              });
              
              console.log('Review comment posted successfully');
              
            } catch (error) {
              console.error('Error processing response:', error);
              
              // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ëŒ“ê¸€ ì‘ì„± ì‹œë„
              try {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: `### âš ï¸ AI ì½”ë“œ ë¦¬ë·° ì˜¤ë¥˜
                  
ì½”ë“œ ë¦¬ë·° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: \`${error.message}\`

ì›Œí¬í”Œë¡œìš° ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`
                });
              } catch (commentError) {
                console.error('Failed to post error comment:', commentError);
              }
            }
